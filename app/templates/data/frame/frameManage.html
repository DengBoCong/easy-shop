{% extends "base/basic.html" %}
{% block title %}{% endblock %}
{% block css %}{% endblock %}
{% block content %}
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">
                    Frame树状列表--点击Frame加载详情数据
                    <a href="javascript:;" layadmin-event="verbFrameTreeRefresh" title="刷新">
                        <i class="layui-icon layui-icon-refresh-3"></i>
                    </a>
                </div>
                <div class="layui-card-body">
                    <div id="LAY_frame_tree"></div>
                    <div style="height: 20px;"></div>
                </div>
            </div>
        </div>
        <div class="layui-col-md8" id="frameCard">
            <iframe id="subFrameIframe" src="" frameborder="0" height="100%" width="100%"
                            scrolling="auto"></iframe>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
    autoheight();
	function autoheight(){
		var winHeight=0;
		if (window.innerHeight)
			winHeight = window.innerHeight;
		else if ((document.body) && (document.body.clientHeight))
			winHeight = document.body.clientHeight;
		if (document.documentElement && document.documentElement.clientHeight)
			winHeight = document.documentElement.clientHeight;
		document.getElementById("frameCard").style.height= winHeight +"px";
	}
	window.οnresize=autoheight; //浏览器窗口发生变化时同时变化DIV高度
    layui.config({
        base: '../static/' //静态资源所在路径
    }).extend({
        index: 'lib/index', //主入口模块
    }).use(['index', 'tree', 'util'], function () {
        var $ = layui.$,
            admin = layui.admin,
            tree = layui.tree,
            layer = layui.layer,
            util = layui.util;
        var remainFrameId = ''
        admin.events.verbFrameTreeRefresh = function (othis) {
            var refreshBtn = layer.load(2);
            admin.req({
                method: "get",
                url: 'api/data/get!get_all_frame?spreadId=' + remainFrameId,
                done: function (res) {
                    tree.reload('frameTree', {data: res.data});
                    layer.close(refreshBtn);
                }
            })
        };

        admin.req({
            method: "get",
            url: 'api/data/get!get_all_frame',
            done: function (res) {
                if (res.code == 0) {
                    tree.render({
                        elem: '#LAY_frame_tree'
                        , data: res.data
                        , id: 'frameTree'
                        , onlyIconControl: true
                        , edit: ['add', 'del'] //操作节点的图标
                        , click: function (obj) {
                            if (obj.data.id === 'verb-root-node-id') {
                                layer.msg("顶级根节点不允许进行操作，请选择其他子节点操作！");
                            } else {
                                layer.load(2);
                                $('#subFrameIframe').attr('src', 'frameDetails?frame=' + obj.data.id)
                                remainFrameId = obj.data.id
                            }
                        }
                        , operate: function (obj) {
                            var type = obj.type; //得到操作类型：add、edit、del
                            var data = obj.data; //得到当前节点的数据
                            var elem = obj.elem; //得到当前节点元素

                            //Ajax 操作
                            var id = data.id; //得到节点索引
                            if (type === 'add') { //增加节点
                                //返回 key 值
                                admin.req({
                                    method: "post",
                                    url: 'api/data/add!add_frame',
                                    data: JSON.stringify({
                                        'PARENT_ID': obj.data.id,
                                        'IF_THIRD': obj.data.if_third,
                                        'HAS_VERB': obj.data.has_verb}),
                                    done: function (res) {
                                        layer.msg(res.msg);
                                        tree.reload('frameTree', {data: res.data.frame});
                                        if (res.data.newId !== 'null') {
                                            $('#subFrameIframe').attr('src', 'frameDetails?frame=' + res.data.newId)
                                            remainFrameId = res.data.newId
                                        }
                                    }
                                });
                            } else if (type === 'del') { //删除节点
                                admin.req({
                                    method: "post",
                                    url: 'api/data/delete!delete_frame',
                                    data: JSON.stringify({'ID': obj.data.id}),
                                    done: function (res) {
                                        layer.msg(res.msg);
                                        // tree.reload('frameTree', {data: res.data});
                                        $('#subFrameIframe').attr('src', '')
                                        remainFrameId = ''
                                    }
                                });
                            };
                        }
                    });
                    parent.layer.closeAll();
                } else {
                    layer.msg(res.msg, {icon: 5});
                }
            }
        });
    });
</script>
{% endblock %}
